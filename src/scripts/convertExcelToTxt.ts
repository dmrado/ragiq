// scripts/convertExcelToTxt.ts

import * as XLSX from "xlsx";
import * as fs from "fs";
import * as path from "path";
import dotenv from "dotenv";

dotenv.config();

// === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π ===
export function generateFileName(baseName: string) {
    const now = new Date();
    const stamp = now.toISOString().replace(/[:.]/g, "-");
    const ext = path.extname(baseName);
    const name = path.basename(baseName, ext);
    return `${name}_${stamp}${ext}`;
}

// === –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Excel –≤ TXT ===
export function convertExcelToTxt(workbook: XLSX.WorkBook, inputFile: string, outputFile: string) {
    console.log(`üìÇ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel ${inputFile} –≤ ${outputFile} ...`);
    
    // –ß—Ç–µ–Ω–∏–µ Excel —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ route.ts, –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    // XLSX.utils.sheet_to_json –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    const data: any[] = XLSX.utils.sheet_to_json(sheet);

    const required = [
        "–ó–∞–∫–∞–∑ ‚Ññ",
        "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ–Ω–¥–µ—Ä–∞",
        "–°—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏",
        "–ì–æ–¥ –ø–æ—Å—Ç–∞–≤–∫–∏",
        "–ú–µ—Å—Ç–æ, —É—Å–ª–æ–≤–∏—è –∏ —Å—Ä–æ–∫–∏ (–ø–µ—Ä–∏–æ–¥—ã) –ø–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–∞",
        "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
        "–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞",
        "–î–æ–∑–∏—Ä–æ–≤–∫–∞ + –§–∞—Å–æ–≤–∫–∞",
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–æ–∫ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç)",
    ];

    if (data.length === 0) {
         throw new Error(`‚ùå –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞.`);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –¥–∞–Ω–Ω—ã—Ö
    const missing = required.filter((key) => !(key in data[0]));
    if (missing.length) {
        throw new Error(`‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–æ–ª–æ–Ω–æ–∫: ${missing.join(", ")}`);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    const textContent = data
        .map(
            (row) => `–ó–∞–∫–∞–∑ ‚Ññ: ${row["–ó–∞–∫–∞–∑ ‚Ññ"]}
–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ–Ω–¥–µ—Ä–∞: ${row["–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ–Ω–¥–µ—Ä–∞"]}
–°—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏: ${row["–°—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏"]}
–ì–æ–¥ –ø–æ—Å—Ç–∞–≤–∫–∏: ${row["–ì–æ–¥ –ø–æ—Å—Ç–∞–≤–∫–∏"]}
–ú–µ—Å—Ç–æ –∏ —É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏: ${row["–ú–µ—Å—Ç–æ, —É—Å–ª–æ–≤–∏—è –∏ —Å—Ä–æ–∫–∏ (–ø–µ—Ä–∏–æ–¥—ã) –ø–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–∞"]}
–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: ${row["–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"]}
–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞: ${row["–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞"]}
–î–æ–∑–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∞—Å–æ–≤–∫–∞: ${row["–î–æ–∑–∏—Ä–æ–≤–∫–∞ + –§–∞—Å–æ–≤–∫–∞"]}
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–æ–∫ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç): ${row["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–æ–∫ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç)"]}

---`
        )
        .join("\n");

    fs.writeFileSync(outputFile, textContent, 'utf-8');
    console.log(`‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ ${outputFile}`);
}

// === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —á–∞–Ω–∫–æ–≤ ===
export function chunkText(text: string, size: number): string[] {
    const chunks: string[] = [];
    for (let i = 0; i < text.length; i += size) {
        chunks.push(text.slice(i, i + size));
    }
    return chunks;
}